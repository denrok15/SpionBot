import logging
import os

import requests
from dotenv import load_dotenv

logger = logging.getLogger(__name__)
load_dotenv()

API_KEY_LLM = os.getenv("API_KEY_LLM")
URL_LLM = os.getenv("URL_LLM")
PROMPTS = {
    "dota2": """
    Ты — профессиональный генератор подсказок для игры «Шпион».
    Тема: герои Dota 2.
    Задача:
    Сгенерировать подсказки ДЛЯ КАЖДОГО героя Dota 2 из официального ростера.
    Для каждого героя:
    - создать 5 подсказок уровня easy
    - 5 подсказок уровня medium
    - 5 подсказок уровня hard
    Правила сложности:
    easy:
    - максимально общие характеристики
    - НЕ использовать уникальные признаки
    - НЕ упоминать способности, роли, механику, лор, оружие, внешний вид
    - подсказки должны подходить сразу нескольким героям
    medium:
    - намёки на стиль игры, роль, тип урона или поведение в матче
    - без названий способностей, предметов, терминов
    - всё ещё НЕ должно быть однозначно
    hard:
    - тонкие детали: лор, характер, история, неочевидные визуальные или геймплейные особенности
    - понятны в основном опытным игрокам
    - запрещены прямые спойлеры и уникальные слова
    Глобальные ограничения:
    - ЗАПРЕЩЕНО использовать имя героя или его производные
    - ЗАПРЕЩЕНО использовать названия способностей, предметов, фракций, ультимейтов
    - ЗАПРЕЩЕНО использовать цитаты героя
    - Каждая подсказка — одно короткое предложение
    - Подсказки внутри одного уровня не должны повторять смысл
    Формат ответа — СТРОГО JSON:
    {
      "HeroName": {
        "easy": [5 подсказок],
        "medium": [5 подсказок],
        "hard": [5 подсказок]
      }
    }
    Требования к результату:
    - Включить ВСЕХ героев Dota 2
    - Использовать точные английские имена героев как ключи JSON
    - Язык подсказок: русский
    - Никакого текста вне JSON
""",
    "clash_royale": """
    Ты — профессиональный генератор подсказок для игры «Шпион».
    Тема: карты Clash Royale.
    Задача:
    Сгенерировать подсказки ДЛЯ КАЖДОЙ карты Clash Royale из официального ростера.
    Для каждой карты:
    - создать 5 подсказок уровня easy
    - 5 подсказок уровня medium
    - 5 подсказок уровня hard
    
    Правила сложности:
    easy:
    - максимально общие характеристики
    - НЕ использовать уникальные признаки
    - НЕ упоминать названия карт, способности, стоимость эликсира, редкость
    - НЕ упоминать внешний вид напрямую
    - подсказки должны подходить сразу нескольким картам
    
    medium:
    - намёки на стиль использования, роль в колоде, поведение на арене
    - можно косвенно намекать на тип (войска / здание / заклинание), но без прямых терминов
    - без названий карт, механик и игровых терминов
    - всё ещё НЕ должно быть однозначно
    
    hard:
    - тонкие детали: лор, характер, история мира Clash, неочевидные особенности поведения или взаимодействий
    - понятны в основном опытным игрокам
    - запрещены прямые спойлеры и уникальные слова, однозначно указывающие на карту
    
    Глобальные ограничения:
    - ЗАПРЕЩЕНО использовать имя карты или его производные
    - ЗАПРЕЩЕНО использовать названия способностей, эффектов, редкостей
    - ЗАПРЕЩЕНО использовать игровые термины (эликсир, цикл, сплэш, таргет и т.п.)
    - ЗАПРЕЩЕНО использовать цитаты
    - Каждая подсказка — одно короткое предложение
    - Подсказки внутри одного уровня не должны повторять смысл
    
    Формат ответа — СТРОГО JSON:
    {
      "CardName": {
        "easy": [3 подсказок],
        "medium": [3 подсказок],
        "hard": [3 подсказок]
      }
    }
    
    Требования к результату:
    - Включить ВСЕ карты Clash Royale из официального ростера
    - Использовать точные английские имена карт как ключи JSON
    - Язык подсказок: русский
    - Никакого текста вне JSON
    """
}
async def ask_llm(prompt: str) -> str:
    headers = {
        "Authorization": f"Bearer {API_KEY_LLM}",
        "Content-Type": "application/json"
    }
    payload = {
        "model": "mistralai/devstral-2512:free",
        "messages": [
            {"role": "system", "content": "Ты точный генератор игровых подсказок."},
            {"role": "user", "content": prompt}
        ],
        "temperature": 0.3
    }
    response = requests.post(URL_LLM, headers=headers, json=payload)
    response.raise_for_status()
    logger.info("получен ответ от нейросети")
    return response.json()["choices"][0]["message"]["content"]
