name: Deploy to Yandex Cloud
on:
  workflow_dispatch:
    inputs:
      force_deploy:
        description: 'Force deploy even if other workflows are running'
        required: false
        default: 'false'
        type: choice
        options:
          - 'false'
          - 'true'
jobs:
  check-workflows:
    runs-on: ubuntu-latest
    outputs:
      can_deploy: ${{ steps.check.outputs.can_deploy }}
      running_workflows: ${{ steps.check.outputs.running_workflows }}
    steps:
    - name: Check for running workflows
      id: check
      uses: actions/github-script@v7
      with:
        script: |
          const { owner, repo } = context.repo;
          
          const runs = await github.rest.actions.listWorkflowRunsForRepo({
            owner,
            repo,
            status: 'in_progress',
            per_page: 50
          });
          
          const currentRunId = context.runId;
          const otherRuns = runs.data.workflow_runs.filter(run => 
            run.id !== currentRunId && 
            run.status === 'in_progress'
          );
          
          if (otherRuns.length > 0) {
            const workflowNames = otherRuns.map(run => run.name).join(', ');
            console.log(âš ï¸ Found ${otherRuns.length} other workflows in progress:);
            console.log(workflowNames);
            const forceDeploy = '${{ github.event.inputs.force_deploy }}' === 'true';
            
            if (!forceDeploy) {
              core.setOutput('can_deploy', 'false');
              core.setOutput('running_workflows', workflowNames);
              core.setFailed(Cannot deploy while other workflows are running: ${workflowNames}. Use force_deploy option to override.);
              return;
            } else {
              console.log('âš ï¸ Force deploy enabled - proceeding despite running workflows');
            }
          }
          
          core.setOutput('can_deploy', 'true');
          core.setOutput('running_workflows', '');

  deploy:
    runs-on: ubuntu-latest
    needs: check-workflows
    if: needs.check-workflows.outputs.can_deploy == 'true'

    steps:
    - name: Checkout
      uses: actions/checkout@v4

    - name: Warning about concurrent workflows
      if: needs.check-workflows.outputs.running_workflows != ''
      run: |
        echo "âš ï¸ WARNING: The following workflows are still running:"
        echo "${{ needs.check-workflows.outputs.running_workflows }}"
        echo "Proceeding with deployment as force_deploy was enabled..."
        echo ""

    - name: Deploy via SSH
      uses: appleboy/ssh-action@v1.0.3
      with:
        host: 51.250.99.137
        username: ${{ secrets.SSH_USERNAME }}
        key: ${{ secrets.SSH_PRIVATE_KEY }}
        passphrase: ${{ secrets.SSH_PASSPHRASE }}
        port: 22
        script: |
          cd SpionBot
          
          echo "ðŸ“¦ Stopping containers..."
          docker compose down
          
          echo "ðŸ” Pulling latest changes..."
          git pull origin main
          
          cd ..
          echo "ðŸ—‚ï¸ Preparing version directories..."
          echo "ðŸ“ Creating dir version..."
          mkdir -p version
          
          cd version
          echo "ðŸ“ Creating current/previous folders..."
          mkdir -p SpionBot-curr
          mkdir -p SpionBot-prev
          
          echo "â™»ï¸ Rotating versions (curr -> prev)..."
          rm -rf SpionBot-prev
          mv SpionBot-curr SpionBot-prev
          
          echo "ðŸ“¦ Creating fresh current snapshot..."
          rm -rf SpionBot-curr
          cp -a ../SpionBot SpionBot-curr
          
          echo "âœ… Version snapshot updated!"
          
          cd ../SpionBot
          
          echo "ðŸš€ Building and starting containers..."
          docker compose up -d --build
          
          echo "ðŸ§¹ Cleaning up old images..."
          docker image prune -f
          
          echo "ðŸ“Š Checking container status..."
          sleep 3
          docker compose ps
          
          echo "âœ… Deployment completed successfully!"
